학습목표
1. MongoDB의 튜닝 방법
2. MongoDB 보안 팁
---
**MongoDB튜닝**

개요
**데이터베이스 튜닝이 필요한 시점**
- 시간이 지남에 따라 처음 설계와 사용자의 패턴이 달라졌음
- 잘못된 설계를 가지고 있는 경우
- 처음과 달리 데이터가 축척되거나 장비의 노후화

**데이터베이스 튜닝 방법**
- 데이터 모델 튜닝
- 질의 튜닝
- 아키텍쳐 튜닝
- 인스턴스 튜닝
- 하드웨어 튜닝

---
 - 가장 쉬운 튜닝방법은 하드웨어를 업그레이드 하는 하드웨어 ㅌ닝
 - 데이터모델이나, 질의 튜닝은 비지니스 모델에 대한 깊은 이해를 필요로 하는 어려운 튜닝방법
 - 아키텍쳐 튜닝이나 인스턴스 튜닝은 실 서비스 단계에서 선택하기에 여러운 점이 많음
 - 데이터 모델이나 질의 튜닝도 데이터 마이그레이션을 동반하기 때문에 라이브 모드에서 쉬운 결정은 아님

#### 1. 데이터모델 튜닝

  - 데이터모델 튜닝은 초기에 설계한 데이터모델의 제대로 성능을 발휘하지 못할때 필요한 조치
      - 데이터를 저장하는 논리적 구조인 컬렉션에 대한 적절한 분석과 설계가 사전에 이루어지지 않았을 경우
      - 예측하지 못했던 데이터의 입력했을 경우
      - 프로젝트 막바지에 용도 변경등이 발생했을 경우
  - 최종적으로 현재에 알맞은 데이터 모델을 갖고 있지 못한다면, 결국 지속적인 시스템 성능 저하가 발생하기 때문에, 근본적인 해결이 필요함
  - MongoDB에서는 최초로 컬렉션을 생성하면 기본 익스텐트 크기가 할당됨
      - 이 크기가 너무 작게 지정되면 쓰기 작업이 발생할 때 새로운 익스텐트를 할당 받을 때마다 약간의 지연이 발생하게 됨
      - 결국 이것이 시스템의 성능 저하로 이어질 수 있음
      - 이문제는 MongoDB만의 문제는 아니고 대부분의 관계형 테이터베이스에서도 발생하는 보편적인 문제임
  - 초당 몃 만건 이상되는 빅데이터 처리를 위해서라면 미리 이 숫자를 예측하여 지정해 둘 필요가 있음.
**MongoDB의 Document자료 구조**
  - 데이터를 중첩하여 Embedding 형태로 데이터를 구성하는 것을 추천
  - 다만 내장된 데이터를 관련도와 상관없이 무조건 Emedding형태로 만들 필요는 없음
  - MongoDB에도 데이터가 밀집하지 않다면 Linking(DBRef)방식으로 설계하는 것을 고려해야 함.
**MongoDB도 빠른 검색을 위한 인덱스 시스템을 가지고 있음**
  - 백그라운드 인덱스 타입으로 생성이 가능함
  - insert마다 인덱스를 생성하여 성능 저하가 발생하지 않도록 해야함
  **MongoDB의 복합인덱스(Compound Index)**
  - 기존 RDBMS처럼 다중으로 인덱스를 거는 것이 중요
  - 여러 필드 중 분포도가 좋은 필드를 우선순위로 지정할 필요가 있음
  - 잦은 필드의 수정이나 삭제, 입력이 빈번한 필드는 인덱스에서 가능하면 제외해야 함

#### 2. 질의 튜닝
- MongoDB는 서버에 질의된 문장을 profiling 하는 것이 가능함
- 이 때 분석 결과는 db.system.profile Collection 에 저장됨
- 다른 RDBMS처럼 Explain 함수를 지원하기 때문에 질의 문장들의 분석이 가능함
- 이 명령어를 통해 질의 문장의 성능이 저하되는 원인의 인덱스 문제를 확인할수 있음
- 특정한 경우에 인덱스를 활용하지 못하는 문제를 발견할 수 있기 때문에, 인덱스 생성 정책 결정에 도움이 됨

#### 3. 아키텍쳐 튜닝
- MongoDB는 운영체제의 메모리 설정을 따라가기 때문에 충분 Map Memory영역이 필요함
- 불필요하게 하나 이상의 MongoDB 인스턴스를 띄우게 되면 메모리 부족현상이 발생하기 때문에 실제 성능은 반드시 저하됨
- 가능하면 Memory를 충분히 사용할 수 있도록 하나의 시스템에서는 한 개의 인스턴스만 실행하면 스크래치 디스크(메모리가 부족하여 하드디스크에 일부 메모리를 임시저장하는 기능)을 생성하지 않도록 해야 함.
- 대용량 데이터가 입력될 때는 단일 노드보다 다중 노드로 서비스하는 것이 유리함
- 아무리 MongoDB가 insert 성능이 뛰어나다고 하더라도 하드웨어의 성능 이상을 끌어내기는 어려움
- 샤드 시스템을 갖추면 분산 저장과 Load Balancing의 장점을 얻을 수 있음

#### 4. 하드웨어 튜닝
- HDD보다 SSD를 사용
- 최대의 메모리를 장착하여 충분한 메모리 공간을 확보
- CPU를 다중코어 활용하여 처리하게.
- **Mongopref유틸리티를 사용하면 MongoDB의 Disk I/O 상태 확인가능**

![스크린샷 2017-04-07 오후 5.52.12](http://i.imgur.com/NJbtz7w.png)
![스크린샷 2017-04-07 오후 5.52.47](http://i.imgur.com/5P7NQnX.png)
![스크린샷 2017-04-07 오후 5.53.11](http://i.imgur.com/fUhydr1.png)
![스크린샷 2017-04-07 오후 5.53.52](http://i.imgur.com/autUZex.png)
![스크린샷 2017-04-07 오후 5.55.09](http://i.imgur.com/3YBHJ2W.png)

#### 2. MongoDB보안 팁
**인증 설정**
- MongoDB는 설치 과정 중에 인증과 관련된 설정을 하는 부분이 없음
    - 설치 후 누구나 DB에 접속할 수 있음
    - 허가된 사용자만이 DB에 접속할 수 있도록 계정 및 패스워드를 설정해야함
    - MySQL과 마찬가지로 DB인스턴스를 실행할 때 인증 정보를 사용하겠다는 파라미터(-auth)를 포함해야 함

- 테이터베이스별로 계정과 패스워드를 추가하여 사용하는 것을 권장
    - 각 데이터베이스별 계정 정보는 System.users라는 namespace에 저장됨
    - db.removeUser(username)명령으로 계정 삭제 가능

  ![스크린샷 2017-04-07 오후 6.00.00](http://i.imgur.com/94dD8IW.png)

  use.admin -> db.shutdownServer() 사용해랏!!

  -auth 패러미터를 사용하여 mongod인스턴스를 구동시켜야 함!!

- HTTP인터페이스 보안
    - 누구나 HTTP인터페이스에 접근해서는 안되기 때문에, 반드시 -auth로 인증할 것을 권한다.

-----
 실습 장면 
