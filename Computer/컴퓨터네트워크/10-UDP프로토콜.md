## UDP 프로토콜 (전송 계층)

비연결형 서비스를 제공하는 UDP의 헤더.

*비연결형 서비스? 연결형 서비스?*

> TCP가 대표적인 연결형 서비스이다. 송신 호스트 수신호스트가 전송되기 전에 이미 경로를 설정하여  신뢰성있는 값을 보장한다.
> 반대로 UDP가 비연결형 서비스. 경로가 설정되어 있지 않아 도착유무를 확인하지 않기 때문에 빠른 전송을 보여주지만 신뢰성이 떨어진다. 둘다 전송 계층의 프로토콜이다.

특징

- 비연결형 서비스를 제공
- 헤더와 전송 데이터에 대한 체크섬 기능을 제공
- Best Effort 전달 방식을 지원
  - 전송한 데이터가 제대로 도착했는지 확인을 하지 않음 => 신뢰성이 상대적으로 낮음
  - 데이터 처리가 빠르므로 데이터 전송시간에 민감한 환경에서는 유리
- 헤더 구조가 단순하다.

![](https://ws4.sinaimg.cn/large/006tKfTcgy1fo5blwyabxj31400w4gur.jpg)



## 비연결형서비스?

- 각 데이터 그램이 독립적으로 전송하고, 독립적으로 중개 - 도착순서가 바뀌어 도착할 수 있음
- 원도우프로토콜과 같은 흐름제어가 없으므로 버퍼 오버플로우에 의한 데이터 분실 가능성
- 응용에서 순서번호와 유사한 기능을 구현해야 할 필요성
- UDP에서의 데이터그램 분실
- ![](https://ws4.sinaimg.cn/large/006tKfTcgy1fo5bo8wex9j31220kw7db.jpg)
- UDP에서의 데이터그램 도착순서 변경

![](https://ws4.sinaimg.cn/large/006tKfTcgy1fo5bobyuzjj31060jg47o.jpg)



## RTP(Real Transport Protocol)

- 멀티미디어 서비스 환경의 변화  
  \- 기존 : 비디오, 오디오 파일 전체를 다운받은 후 서비스  
  \- 실시간 스트리밍 서비스 등장  
   	1. 데이터 변형/분실 오류를 복구하는 기능이 상대적으로 덜 중요  
  	2. 도착 순서, 패킷의 지연 간격, 데이터 압축 등이 중요
  	3. TCP  
      \- 패킷의 순서와 신뢰성이 지나치게 강조  
      \- 패킷 재전송 기능과 복잡한 흐름제어로 부적합
  	4. UDP  
      \- 기능이 단순하여 빠른 전송 가능  
      \- 순서를 보장하지 못함
  	5. 가장 현실적인 대안은 UDP에 순서번호 기능을 추가하는 것  
      \- RTP(Real Time Protocol)
- IETF의 오디오, 비디오 트랜스포트 작업반에서 작업
- 데이터 순서 정렬을 위해 타임스탬프(time stamp) 방식 사용
- 프로토콜 동작이 응용프로그램의 라이브러리 형태로 구현되는 ALE(Application Level Function)사용으로 응용마다 별도로 버퍼 크기 조절 및 관리 기능
- 실시간 응용 서비스에 유용  
  \- 자원 예약이나 Qos보장 기능이 없어서 실시간 동영상 서비스 제공에는 부족 

## 실시간 요구사항

- 일반 데이터 서비스 환경
  - 파일전송, 전자메일 등
  - 신뢰성이 중요
  - 성능과 지연 문제는 덜 중요
- 실시간 데이터 서비스 환경
  - 정해진 시간 내에 도착하는지의 여부가 중요
    - 특정 시간 내에 도착하지 못하면 무용지물
  - 신뢰성이 덜 중요

### 01 버퍼의 역할

- 시간 간격이 가변적인 데이터를 즉시 전송하지 않고 지연 버퍼를 사용하여 간격을 일정하게 보정
  - 제한 시간을 넘기는 경우 폐기
- 지연(Latency)
  - 송신 프로세스에서 전송한 데이터의 출발시간과 수신프로세스에 도착한 시간의 차이
  - 대역폭, 네트워크 구조, 라우팅 방식, 전송프로노콜 종류 등에 영향

![](https://ws4.sinaimg.cn/large/006tKfTcgy1fo5bx69g36j30jm0jqjv0.jpg)

### 02 지터(Jitter)

- 실시간 데이터를 전송하는 환경에서는 지터라는 중요한 변수를 고려. 
- 데이터그램의 도착 지연 시간의 분포
  - 도착시간이 일정하지 않고 불규칙적으로 도착하는 정도

![](https://ws4.sinaimg.cn/large/006tKfTcgy1fo5byoc38tj30sy0jutc5.jpg)

## RTP의 데이터 전송 프로토콜

- RTP의 동작 원리

![](https://ws2.sinaimg.cn/large/006tKfTcgy1fo5c439yonj30nc0m2q7o.jpg)

- 작고 빠른 전송 기능을 지원하는 UDP프로토콜 위에서 구현

- 데이터그램 분실이나 도착 순서 변경 등의 오류는 RTP에서 해결

- 포트주소 기능을 이용하여 송수신 프로세스간 연결 관리

- 프로그램 하나를 단위로 하지 않고, 일부 기능이 개별적으로 구현됨

  - 응용서비스의 종류에 따라 요구 조건이 다른 기능들을 추가되는 형식

- 다수의 사용자가 하나의 세션을 사용하여 실시간 데이터 전송 가능

- 두 종류(믹서, 트랜슬레이터)의 RTP 릴레이(Relay) 지원

  - **릴레이** : 데이터 전송 과정에서 송수신 프로세스가 직접 데이터를 전송할 수 없는 상황에서 데이터를 중개하는 기능  
    예 : 방화벽 사용, 데이터 형식 상이

- 믹서  

  \- 여러 송신 프로세스의 데이터그램을 적절히 조합하여 새로운 데이터그램 생성  
  \- 믹싱 과정에서 데이터그램 스트림에 대한 시간 정보 제공  

- 트랜슬레이터  
  \- 입력된 각 RTP데이터그램을 하나 이상의 출력용 데이터그램으로 만들어 줌(데이터 형식 변화 가능)  
  \- 예: 고해상도의 비디오 신호를 저해상도로 변환, 멀티캐스트 RTP데이터그램을 복사하여 다수의 유니캐스트 수신 프로세스에게 전송

## RTP 헤더 구조

- 기본 구조
  ![](https://ws2.sinaimg.cn/large/006tKfTcgy1fo5cebwsskj30mm0mgn10.jpg)
- 응용 환경과 관련된 가변크기의 헤더 추가 가능
- 처음 12바이트는 모든 RTP패킷에 존재
- CSRC구분자는 믹서에 의해 추가된 경우 사용
- 음성과 영상 데이터의 동기에 필요한 시간 정보, 데이터그램 분실이나 도착순서 변경 오류를 검출하는 기능 제공
- 멀티캐스트 전송도 지원
  - 그룹에서 누가 전송했는지 확인을 위해 송신 구분자 필드 존재
- 주요 필드
  - Version(2비트) : 현재 2
  - Padding : 패팅 바이트 존재 여부 표시
  - Extension : 고정 헤더 뒤에 확장 헤더가 이어지는지 여부
  - CSRC Count(4비트) : CSRC구분자 개수
  - Marker(1비트)
    - 임의의 표식을 위해 사용
    - 보통 데이터 스트림의 경계점을 표시
  - Payload Type(7비트) : 페이로드 유형
  - Sequence Number
    - 분실, 순서번호 변경 오류 검출
  - Timestamp
    - 데이터그램의 생성 시기
  - SSRC Identifier
    - Source 구분 / 랜덤하게 생성된 32비트 숫자
  - CSRC Identifier
    - 여러 개 존개 가능(믹서에서 제공)
- 각 미디어가 별도의 RTP세션 이용
  - 오디오와 비디오가 별도의 세션으로 전송
  - RTP헤더에서 동기화에 필요한 시간 정보 제공
  - 페이로드 유형 지정방식을 통해 다양한 종류의 데이터와 압축 형식 지원

## 04 RTP 제어 프로토콜

- RTCP(RTP Control Protocol)
- 제어와 관련된 기능 수행
- UDP를 하부 계층으로 사용
- 세션 참가자는 다른 멤버에게 RTCP 패킷을 주기적으로 전송
- 주요 기능
  - Qos와 혼잡제어
    - 데이터 분배 과정에서 발생하는 서비스 품질에 관한 피드백 기능을 지원
    - 멀티캐스팅 과정에서의 송수신 상태여부 판단을 위한 보고서 작성
      - 송신 프로세스의 전송률, 수신 프로세스의 패킷 분실, 지터 등
  - Identification
    - RTCP 패킷에는 RTCP송신 프로세스에 관한 정보가 포함됨
  - 세션 크기
    - 세션 참가자가 증가할수록 RTP데이터 전송률 감소
    - RTCP데이터그램의 최대 전송률은 5초당 1데이터 그램
  - 세션 제어 : 최소한의 세션 제어 정보를 옵션으로 제공

