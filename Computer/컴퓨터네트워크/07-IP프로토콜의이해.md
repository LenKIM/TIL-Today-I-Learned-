### 네트워크 계층의 기능

네트워크 계층은 전송 데이터인 패킷을 목적지까지 올바른 경로로 전달해준다. 패킷은 최종 목적지까지 전달되는 과정에서 라우터들은 거치는데, 이때 적절한 경로를 선택해 패킷을 전달하는 라우팅 기능을 수행.

네트워크 계층의 주요 기능

```Xml
- 주요 기능
	라우팅
	혼잡제어
	패킷 분활과 병합
- 연결형/비연결형 서비스
- 정적/동적 라우팅
- 소스/분산/중앙/계층 라우팅
```

- 라우팅(Routing)
  \- 라우팅 테이블  
  : 네트워크 구성 형태에 관한 정보를 관리, 그리고 이 정보를 이용해 패킷이 목적지까지 도달하기 위한 경로를 선택

- 혼합 제어(Congestion Control)
  \- 혼잡(congestion)  
  : 네트워크에 패킷 수가 과도하게 증가되는 현상.

  혼잡의 발생을 예방하거나 제거하는 기능. 혼잡이 발생하면 네트워크 전체의 전송 속도가 급격히 떨어지므로 혼잡이 발생하지 않도록 관리해야 한다.

- 패킷의 분할과 병합

  \- 상위 계층에서 내려온 데이터는 하위 계층인 MAC 계층의 프레임 구조에 정의된 형식으로 캡슐화  
  \- 송신 호스트에서는 전송 전에 적절한 크기로 데이터를 분할(Segmentation)  
  \- 수신 호스트는 분할되어 수신한 데이터를 다시 병합(Reassemble)  

## 서비스의 종류

### 01 연결형, 비연결형 서비스

네트워크 계층이 전송 계층에 제공하는 서비스는 크게 두 가지이다.  
패킷을 전송하기 전에 송수신 호스트 사이에 연결을 설정하는 연결형 서비스와  
연결 설정 없이 데이터를 패킷 단위로 전송하는 비연결형 서비스  
![](https://ws2.sinaimg.cn/large/006tNc79ly1fnx9e1cvq4j30y60fc0yq.jpg)

- 연결형 :
  \- 데이터 전송 전에 데이터의 전송 경로를 미리 결정  
- 비연결형:
  \- 데이터의 전송 경로를 사전에 결정하지 않고 패킷 단위로 결정  

#### 비연결형 서비스

패킷의 전달 순서, 패킷 분실 여부 등에서 연결형 서비스보다 신뢰성이 떨어지는 전송 방식.  
따라서 전송 계층에서 네트워크 계층의 비연결성 서비스를 이용할 때는 연결형 서비스를 이용하는 경우보다 자체적으로 오류 제어와 흐름 제어 기능을 더 많이 수행해야 한다.  

비연결형 서비스를 이용해 패킷을 전송하면 패킷이 서로 다른 경로를 통해 목적지 호스트로 전달되기 때문에 패킷이 도착하는 순서가 일정하지 않을 수 있다. 따라서 상위 계층인 전송 계층은 수신한 패킷의 순서를 재조정하는 기능이 필요하다.

- 인터넷 환경의 예  
  \-  IP : 네트워크 계층의 기능을 지원하는 비연결형 프로토콜  
  \- UDP : 전송 계층의 기능을 지원하는 비연결형 프로토콜



### 연결형 서비스

- 상대적으로 신뢰성이 높은 서비스로, 패킷을 전송하기 전에 연결을 미리 설정하여 송신하는 방식이다. 비연결성 서비스와 달리 전달되는 패킷들이 모두 동일한 경로를 이용하기 때문에 목적지에 도착하는 패킷의 순서가 송신된 순서와 동일하다는 특성이 있다.
- TCP : 전송 계층의 기능을 지원하는 연결형 프로토콜

### 02 라우팅

**패킷의 전송 경로를 지정하는 라우팅은 네트워크 계층의 가장 중요한 연결**

- 전송 경로 결정시 고려 사항

  - 공평 원칙 : 다른 패킷의 우선 처리를 위해 다른 패킷이 손해를 보면 안됨  

  - 효율 원칙 : 전체 네트워크의 효율성에 대해 고려해야 함  
    \- 패킷의 평균지연시간, 중간에 거쳐가는 라우터 수 등  

  - 정적/동적 라우팅  
    **\- 정적 라우팅**  

    - 패킷 전송이 이루어지기 전에 경로 정보를 라우터가 미리 저장하여 중개
    - 최적의 라우팅 정보를 개별 라우터에 저장하여 관리
    - 그러나 경로 정보의 갱신이 어려우므로, 네트워크 변화/네트워크 혼잡도 대처 부족이 단점이 된다.

    **\- 동적 라우팅**

    - 라우터의 경로 정보를 네트워크 상황에 따라 적절하게 변경
    - 경로정보 변경 주기에 따른 보완 가능
    - 그러나 복잡한 작업 추가로 필요하고, 경로 정보의 수집과 관리로 인한 성능 저하라는 단점이 있다.

- HELLO/ECHO 패킷

  - HELLO
    - 주변 라우터에 HELLO 패킷을 보내어 주변 경로 정보를 파악하는 용도.
  - ECHO
    - 라우터 사이의 전송 지연 시간을 측정하는 용도

- 임의의 라우터가 획득한 정보를 각 라우터에 통보함으로써 정보 공유

  - 개발 라우터에 도착하는 시간 차이로 인한 정보 불일치 발생
  - 변화되는 상황에서 일관성 유지가 관건

#### 라우팅 테이블

- 패킷 전송 과정에서 라우터가 패킷의 적절한 경로를 찾기 위한 가장 기본적인 도구
- 이때 필요한 필수 정보는 (목적지 호스트, 다음 홉)의 조합이다.
  - 목적지 호스트 : 패킷의 최종 목적지가 되는 호스트 주소
  - 다음 홉 : 목적지 호스트까지 패킷을 전달하기 위한 인접 경로

![](https://ws3.sinaimg.cn/large/006tNc79ly1fnx9xiurwlj30ts0gg0z1.jpg)



*그림이 이해가 안됨*



#### 라우팅 정보의 처리

라우팅을 효과적으로 수행하려면 라우팅 정보가 네트워크의 현재 상황을 정확히 반영할 수 있도록 관리해야 한다. 라우팅 정보 관리와 관련된 처리 방법에는 소스 라우팅, 분산 라우팅, 중앙 라우팅, 계층 라우팅 등이 있다.

- 소스 라우팅
  \- 송신 호스트가 패킷의 전달 경로를 결정하는 방식  
  \- 전송 경로는 전송 패킷 내부에 기록됨  
  \- 모든 라우팅 정보를 송신 호스트가 관리하므로 중간에 있는 라우터들은 라우팅 테이블을 따로 관리할 필요가 없다.
- 분산 라우팅(Distributed)  
  \- 라우팅 정보를 분산하여 관리하는 방식  
  \- 호스트의 개수가 많아질수록 효과적  
  \- 데이터그램에서 많이 사용한다.
- 중앙(Centralized) 라우팅  
  \- RCC(Routing Control Center)라는 특별한 호스트를 사용해 전송경로에 관한 모든 정보를 관리하는 방식.  
  패킷 전송을 원하는 송신 호스트는 반드시 RCC로부터 목적지 호스트까지 도착하기 위한 경로 정보를 미리 얻어야 한다.  
  \- 즉, 호스트이 개수가 많아질수록 비효율적이다.
- 계층(Hierarchical) 라우팅  
  \- 분산 라우팅과 중앙 라우팅의 조합  
  \- 네트워크 규모가 커질수록 매우 효과적임



#### 흐름제어와 혼잡제어

흐름제어 - 송수신 호스트 사이의 전송 속도 문제

혼잡제어 - 네트워크에서의 전송 능력 문제

![](https://ws1.sinaimg.cn/large/006tNc79ly1fnxa61zhozj30xg0huafu.jpg)

### 혼잡 제어

네트워크에 존재하는 전송 패킷의 수가 많아질수록 네트워크의 성능은 자연스럽게 감소한다. 이와 같은 성능 감소 현상이 급격하게 악화되는 현상을 **혼잡**이라하고 혼잡 문제를 해결하기 위한 방안을 **혼잡 제어**라고 한다.  

- 혼잡의 원인

  - 타임 아웃 기능에 의한 패킷의 재전송으로 혼잡도 증가.
    - 초기 혼잡 과정에서 타임아웃시간이 작으면 혼잡도가 급격히 증가
    - 패킷 도착 순서가 다른 상황에서 패킷을 분실처리하면 타임아웃 증가 -> Go-back-N과 Selective Repeat
    - 의도적으로 피기배킹을 사용하면 응답 시간이 느려져 타임아웃 증가
    - 패킷 생존 시간을 작게하면 패킷이 강제로 제거되어 타임아웃 증가

- 라우팅 알고리즘

  - 혼잡이 발생하지 않는 경로를 배경하도록 설계
  - 혼잡이 발생하는 경로를 선택하면 혼잡이 주변으로 확대됨

- 트레픽 성형

  - 혼잡의 발생은 트래픽이 특정 시간에 집중되는 버스트(Burst) 현상이 원인.
  - 패킷 발생 정도를 네트워크에서 예측 가능한 정도로 조절하는 기능이 필요
  - 리키 버킷 알고리즘
    ![](https://ws1.sinaimg.cn/large/006tNc79ly1fnxafe7bufj30ug0gcwi8.jpg)

  ​

- 혼잡 제어

  - 특정 지역의 혼잡이 다른 지역으로 확대되지 않도록 하는 것이 중요.
  - 자원 예약 방식
    - 호스트와 서브넷이 미리 네트워크 자원의 사용정도를 협상하여 사전예약
    - 단점 : 자원 낭비 가능성
  - 초크(Choke) 패킷
    - ECN패킷
    - 출력 경로를 사용하는 빈도를 모니터
    - 한계치가 넘어가면 송신호스트에게 주의 표시
    - 초크 패킷을 받은 호스트는 송신 패킷 양을 줄임

https://m.blog.naver.com/PostView.nhn?blogId=jk130694&logNo=220731718934&proxyReferer=https%3A%2F%2Fwww.google.co.kr%2F





### 라우팅

라우팅 기능을 이해하고 관련 프로토콜을 알아본다.

- 간단한 라우팅 프로토콜  
- 거리-벡터 프로토콜 - RIP(Routing Information Protocol)
- 링크상태 프로토콜 - OSPF(Open Shortest path First)
- 외부 라이팅 프로토콜 - BGP(Border Gatewat Protocol)

### 간단한 라우팅 프로토콜

**최단 경로 라우팅**  
\- 거리 기준은 다양하지만 중간에 거쳐가는 홉(hop)수로 판단  
\- 패킷이 목적지로 가는 동안 거치는 라우터 수가 최소가 되로록 경로를 선택  
\- 기타 거리 기준  
​	패킷의 전송 지연, 전송 대역폭, 통신 비용

**플러딩(Flooding)**
\- 라우터가 입력된 패킷을 출력 가능한 모든 경로로 중개하는 방식  
\- 네트워크에 패킷이 무한 개 만들어질 위험  
​	\- 홉 수를 일정 범위로 제한하고 제거  
\- 중요한 데이터를 모든 호스트에게 동시에 전달하는 환경에서 제한적으로 사용



### 거리-벡터 라우팅 프로토콜

- 라우터가 자신과 직접 연결된 주변 라우터에게 라우팅정보를 교환하는 방식  
  \- 전체 네트워크에 대한 지식  
  \- 이웃 라우터에게만 전달  
  \- 일정한 주기로 정보 공유  
- 교환 정보는 전체 네트워크에 속하는 개별 네트워크까지 걸리는 거리 정보
- 개발 라우터에서 유지하는 필수 정보  
  \- 링크 백터: 직접 연결된 네트워크에 대한 연결 정보  
  \- 거리 벡터: 전체 개별 네트워크에 대한 거리 정보  
  \- 다음 홉 벡터: 개별 네트워크로 가기 위한 다음 홉 정보  
  ![](https://ws2.sinaimg.cn/large/006tNc79ly1fnxgpmb3fwj31400pkdpb.jpg)
- RIP(Routing Information Protocol)
  - 거리 벡터 방식
  - 소규모 네트워크 환경에 적합
  - 주변 라우터가 제공하는 거리벡터 정보가 임의의 짧은 시간내에 모두 도착해야한다. 그러나 현실적으로 구현이 어렵다.
  - 라우팅 정보를 수정하는 경우
    - 거리 벡터 정보가 새로운 네트워크 주소면 적용
    - 목적지까지의 지연이 더 적으면 기존 경로를 대체
    - 거리 벡터 정보가 입력되면 등록 정보를 수정

![](https://ws3.sinaimg.cn/large/006tNc79ly1fnxgy0q0cij30iq0jmju7.jpg)

![](https://ws1.sinaimg.cn/large/006tNc79ly1fnxgy2smacj31220r2134.jpg)

![](https://ws1.sinaimg.cn/large/006tNc79ly1fnxgy5mwpyj31580nydpu.jpg)

### 링크상태 프로토콜

거리-벡터 프로토콜의 단점 개선. 뭐를?

주변 상황에 변화가 있을 때, 주변 라우터까지의 정보를 모든 라우터에게 전달이라는 단점.

- 플러딩(Flooding)방식을 사용해서 정보 전달
- OSPF(Open Shortest Path First)프로토콜

![](https://ws1.sinaimg.cn/large/006tNc79ly1fnxh1ev6pyj313u0w4n80.jpg)

![](https://ws3.sinaimg.cn/large/006tNc79ly1fnxh1j5cw1j31340uwgwh.jpg)

![](https://ws1.sinaimg.cn/large/006tNc79ly1fnxh2k5rh2j310m0tqalo.jpg)

![](https://ws4.sinaimg.cn/large/006tNc79ly1fnxh4bev9sj314a0ukdtf.jpg)

![](https://ws3.sinaimg.cn/large/006tNc79ly1fnxh4fgoccj31440umqgf.jpg)

![](https://ws3.sinaimg.cn/large/006tNc79ly1fnxh4jad7pj313y0ukqg0.jpg)

![](https://ws3.sinaimg.cn/large/006tNc79ly1fnxh4nauloj313a0wcgyo.jpg)

![](https://ws2.sinaimg.cn/large/006tNc79ly1fnxh4qd600j312w0vs4ds.jpg)

![](https://ws2.sinaimg.cn/large/006tNc79ly1fnxh57tr5sj313i0v0dsl.jpg)

### IP 프로토콜

인터넷 환경에서 네트워크 계층의 데이터 전송 프로토콜로 이용되는 IP는 호스트 주소 표기, 패킷 분할에 관한 기능을 지원하지만, End to End 형식의 오류제어나 흐름 제어기능은 제공하지 않는다.  

IP프로토콜에서 라우터 간의 패킷을 중개할 때는 Best Effort라는 원칙에 따라 전송하지만, 이 방식은 전송 패킷이 수신 호스트에 100% 도착하는 것을 보장하지 않는다. 따라서 IP프로토콜에서 제공하지 않는 전송 오류 문제를 상위 계층에서 고려해야 한다. IP프로토콜의 주요 특징은 다음과 같다

- 비연결형 서비스제공
- 패킷을 분할/병합 하는 기능을 수행
- 데이터 체크섬을 제공하지 ㅇ낳고, 헤더 체크섬만 제공
- Best Effort원칙에 따른 전송 기능 제공

#### 01 IP헤더 구조

![](https://ws2.sinaimg.cn/large/006tNc79ly1fnxhf0bqj3j30o60iaadg.jpg)

- Service Type 필드  
  \- 사용자에게 제공하는 서비스 품질에 관련된 내용
- DS(Differentiated Service)  
  \- 사전에 서비스 제공자와 서비스 이요자 사이에 서비스 등급에 대해 합의  
  \- 동일한 DS값을 갖는 트래픽들은 동일한 서비스 등급으로 처리함
- ECN(Explicit Congestion Notification)  
  \- ECT 0와 ECT1은 동일한 의미  
  \- ECN기능을 위하여 TCP 프로토콜의 헤더에 ECE필드와 CWR필드가 추가

![](https://ws4.sinaimg.cn/large/006tNc79ly1fnxhjfnc1uj310w0acq7i.jpg)

- 패킷 분할 관련 필드  
  \- 상위 계층에서 내려온 데이터가 하나의 패킷으로 전달하기에 너무 큰 경우 분할하여 전송  
  \- Identification(식별자 혹은 구분자)  
  ​	\- 분할되지 않은 패킷 : 값을 순차적으로 증가  
  ​	\- 분할된 패킷 : 동일한 번호 부여  
  \- DF(Don't Fragment): 패킷 분할 금지  
  \- MF(More Fragment)  
  ​	\- 분할된 패킷의 처음과 중간 : 1  
  ​	\- 분할된 패킷의 마지막 : 0  
  \- Fragment Offset(13bits)  
  ​	\- 분할되기 전 데이터에서의 상대적인 위치 정보  
  ​	\- 8바이트의 배수로 지정
- 주소 관련 필드  
  Source Address는 송신 호스트의 주소이고, Destionation Address는 수신 호스트의 IP주소이다.
  IP 주소 체계는 크게 다섯 가지  
  클래스 ABC는 주소를 network와 host필드로 구분해 관리함으로써, 클래스별로 네트워크 크기에 따라 주소 관리를 다르게 한다.
  - network(네트워크) : 네트워크 주소, 전 세계적으로 유일한 번호가 모든 컴퓨터 네트워크에 할당된다. 현재 이 주소의 할당은 NIC에서 담당한다.
  - Host(호스트) : 네트워크 주소가 결정되면 하위의 호스트 주소를 의미하는 host비트 값을 개별 네트워크의 관리자가 할당한다. 클래스 A는 host비트의 크기가 크기 때문에 규모가 큰 네트워크에서 사용하고, 클래스 C는 규모가 작은 네트워크에서 사용한다.

![](https://ws3.sinaimg.cn/large/006tNc79ly1fnxhs5vju2j312y0ju0yc.jpg)

맨 왼쪽의 주소 대역을 보고 어디 클래스에 속해있는지 판단한다.

- 기타필드  

  \- Version Number  
  \- Header Length  
  \- Packet Length  
  \- Transport(전송 프로토콜)  
  \- Time To Live(TTL)  
  \- Header Checksum  
  \- Options  
  \- Padding  



### 패킷 분할

왜 패킷의 분할이 필요한가? 각 네트워크에서 다루는 프레임의 크기가 다르기 때문이다.  

- X.25, Ethernet
- 여러 종류의 네트워크를 걸쳐 패킷 전달

![](https://ws1.sinaimg.cn/large/006tNc79ly1fnxhwm372gj30xg0i278i.jpg)

![](https://ws1.sinaimg.cn/large/006tNc79ly1fnxhxqsaraj313y0wc13q.jpg)

### DHCP 프로토콜

특정 네트워크를 관리하는 네트워크 관리자는 개별 호스트들에 수동으로 고정 IP주소를 할당할 수 있다. 그러나 IP주소 부족등의 사유로 DHCP를 사용하여 자동으로 할당할 수 있다.

자동으로 할당 가능한 IP주소는 DHCP서버가 관리하는 풀에 저장되어 관리되며, 클라이언트로부터 IP주소 요청이 오면 풀에서 하나의 IP주소를 할당한다. 이후 사용이 끝나면 다시 IP주소 풀로 반환되어 다른 호스트가 사용할 수 있다. DHCP메시지는 UDP데이터그램에 캡슐화되어 전송되며, 클라이언트의 포트번호는 68, DHCP서버의 포트번호는 67이다.